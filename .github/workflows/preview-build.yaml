# ============================================================
# Preview Environment CI Pipeline
# ============================================================
# 1. Builds and pushes Docker image
# 2. Adds "preview" label to trigger ArgoCD
# 3. Connects to Tailscale to reach homelab
# 4. Runs tests against preview environment
# ============================================================

name: Preview Environment CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master]

env:
  IMAGE_NAME: shoofio/preview-demo
  PREVIEW_DOMAIN: shoofio.com
  TAILSCALE_DOMAIN: jerboa-hops.ts.net

jobs:
  build:
    name: ğŸ³ Build & Push
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      sha_short: ${{ steps.meta.outputs.sha_short }}
      pr_number: ${{ steps.meta.outputs.pr_number }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ·ï¸ Generate metadata
        id: meta
        run: |
          SHA_SHORT=$(echo ${{ github.event.pull_request.head.sha }} | cut -c1-7)
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "image_tag=pr-${PR_NUMBER}-${SHA_SHORT}" >> $GITHUB_OUTPUT
      
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - uses: docker/setup-buildx-action@v3
      
      - uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.image_tag }}
          build-args: |
            COMMIT_SHA=${{ github.event.pull_request.head.sha }}
            PR_NUMBER=${{ steps.meta.outputs.pr_number }}
            BRANCH_NAME=${{ github.head_ref }}
            BUILD_TIME=${{ github.event.pull_request.updated_at }}
            IMAGE_TAG=${{ steps.meta.outputs.image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: ğŸš€ Trigger Deploy
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pull-requests: write
    
    steps:
      - name: ğŸ·ï¸ Add preview label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.build.outputs.pr_number }},
              labels: ['preview']
            });
      
      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.build.outputs.pr_number }};
            const imageTag = '${{ needs.build.outputs.image_tag }}';
            const previewUrl = `https://preview-pr-${prNumber}.${{ env.PREVIEW_DOMAIN }}`;
            
            // Delete old comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            for (const comment of comments.data) {
              if (comment.body.includes('ğŸš€ Preview Environment')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id
                });
              }
            }
            
            const body = [
              '## ğŸš€ Preview Environment',
              '',
              `ğŸ³ **Image:** \`${{ env.IMAGE_NAME }}:${imageTag}\``,
              '',
              `ğŸ”— **URL:** [${previewUrl}](${previewUrl})`,
              '',
              '> â³ ArgoCD is deploying... (1-2 min)',
              '> ğŸ—‘ï¸ Auto-deleted when PR closes'
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    needs: [build, deploy]
    permissions:
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ” Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
      
      - name: â³ Wait for environment
        id: wait
        run: |
          # Use Tailscale domain - accessible within the tailnet
          URL="https://preview-pr-${{ needs.build.outputs.pr_number }}.${{ env.TAILSCALE_DOMAIN }}"
          echo "Waiting for: ${URL}"
          
          for i in $(seq 1 60); do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${URL}/health" 2>/dev/null || echo "000")
            echo "Attempt ${i}/60: ${CODE}"
            [ "$CODE" = "200" ] && echo "ready=true" >> $GITHUB_OUTPUT && exit 0
            sleep 10
          done
          
          echo "ready=false" >> $GITHUB_OUTPUT
          exit 1
      
      - name: ğŸ§ª Run tests
        if: steps.wait.outputs.ready == 'true'
        run: |
          URL="https://preview-pr-${{ needs.build.outputs.pr_number }}.${{ env.TAILSCALE_DOMAIN }}"
          
          echo "Testing: ${URL}"
          
          # Health check
          curl -sf "${URL}/health" | grep -q '"status":"healthy"' && echo "âœ… Health OK" || exit 1
          
          # Page loads
          [ "$(curl -s -o /dev/null -w '%{http_code}' ${URL}/)" = "200" ] && echo "âœ… Page OK" || exit 1
          
          echo "ğŸ‰ All tests passed!"
      
      - name: ğŸ“Š Report results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const ready = '${{ steps.wait.outputs.ready }}' === 'true';
            const passed = '${{ job.status }}' === 'success';
            
            const body = [
              '## ğŸ§ª Test Results',
              '',
              `âœ… **Environment:** ${ready ? 'Ready' : 'âŒ Timeout'}`,
              '',
              `ğŸ§ª **Tests:** ${passed ? 'âœ… Passed' : 'âŒ Failed'}`
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.build.outputs.pr_number }},
              body: body
            });
