# ============================================================
# Preview Environment CI Pipeline
# ============================================================
# This workflow:
# 1. Builds and pushes Docker image on PR events
# 2. Adds "preview" label to trigger ArgoCD deployment
# 3. Waits for the preview environment to be ready
# 4. Runs tests against the live preview
# 5. Reports results back to the PR
#
# The "preview" label is the coordination mechanism between
# CI and ArgoCD - ArgoCD only creates environments for PRs
# that have this label, ensuring the image exists first.
# ============================================================

name: Preview Environment CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master]

env:
  REGISTRY: docker.io
  IMAGE_NAME: shoofio/preview-demo
  PREVIEW_DOMAIN: shoofio.com

jobs:
  # ============================================================
  # JOB 1: Build and Push Docker Image
  # ============================================================
  build:
    name: üê≥ Build & Push Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      sha_short: ${{ steps.meta.outputs.sha_short }}
      pr_number: ${{ steps.meta.outputs.pr_number }}
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üè∑Ô∏è Generate build metadata
        id: meta
        run: |
          SHA_SHORT=$(echo ${{ github.event.pull_request.head.sha }} | cut -c1-7)
          PR_NUMBER=${{ github.event.pull_request.number }}
          BRANCH_NAME=${{ github.head_ref }}
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          IMAGE_TAG="pr-${PR_NUMBER}-${SHA_SHORT}"
          
          echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          
          echo "### üè∑Ô∏è Build Metadata" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| PR Number | #${PR_NUMBER} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${BRANCH_NAME} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${SHA_SHORT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${IMAGE_TAG} |" >> $GITHUB_STEP_SUMMARY
      
      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: üèóÔ∏è Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.image_tag }}
          build-args: |
            COMMIT_SHA=${{ github.event.pull_request.head.sha }}
            PR_NUMBER=${{ steps.meta.outputs.pr_number }}
            BRANCH_NAME=${{ steps.meta.outputs.branch_name }}
            BUILD_TIME=${{ steps.meta.outputs.build_time }}
            IMAGE_TAG=${{ steps.meta.outputs.image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================
  # JOB 2: Trigger ArgoCD Deployment
  # ============================================================
  trigger-deploy:
    name: üöÄ Trigger ArgoCD Deploy
    runs-on: ubuntu-latest
    needs: build
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: üè∑Ô∏è Add preview label to PR
        uses: actions/github-script@v7
        with:
          script: |
            // Add the "preview" label - this triggers ArgoCD to create the environment
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.build.outputs.pr_number }},
              labels: ['preview']
            });
            
            console.log('‚úÖ Added "preview" label - ArgoCD will now create the environment');
      
      - name: üí¨ Comment build status on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.build.outputs.pr_number }};
            const imageTag = '${{ needs.build.outputs.image_tag }}';
            const sha = '${{ needs.build.outputs.sha_short }}';
            const previewUrl = `https://preview-pr-${prNumber}.${{ env.PREVIEW_DOMAIN }}`;
            
            // Find and delete previous bot comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            for (const comment of comments.data) {
              if (comment.body.includes('üöÄ Preview Environment')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id
                });
              }
            }
            
            // Post new comment
            const body = `## üöÄ Preview Environment

            | Status | Details |
            |--------|---------|
            | üê≥ Image | \`${{ env.IMAGE_NAME }}:${imageTag}\` |
            | üìù Commit | \`${sha}\` |
            | ‚è∞ Built | ${new Date().toISOString()} |
            | üè∑Ô∏è Label | \`preview\` added - ArgoCD deploying... |

            ### üîó Preview URL
            \`\`\`
            ${previewUrl}
            \`\`\`
            
            > ‚è≥ **Note:** It may take 1-2 minutes for ArgoCD to sync and deploy.
            > 
            > üóëÔ∏è This environment will be **automatically deleted** when this PR is closed.
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  # ============================================================
  # JOB 3: Wait for Environment & Run Tests
  # ============================================================
  test:
    name: üß™ Test Preview Environment
    runs-on: ubuntu-latest
    needs: [build, trigger-deploy]
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      # --------------------------------------------------------
      # Wait for the preview environment to be ready
      # This polls the health endpoint until it responds
      # --------------------------------------------------------
      - name: ‚è≥ Wait for preview environment
        id: wait
        run: |
          PREVIEW_URL="https://preview-pr-${{ needs.build.outputs.pr_number }}.${{ env.PREVIEW_DOMAIN }}"
          MAX_ATTEMPTS=60  # 60 attempts * 10 seconds = 10 minutes max wait
          ATTEMPT=0
          
          echo "üîç Waiting for preview environment at: ${PREVIEW_URL}"
          echo ""
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}..."
            
            # Try to hit the health endpoint
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 "${PREVIEW_URL}/health" 2>/dev/null || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo ""
              echo "‚úÖ Preview environment is ready!"
              echo "ready=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "   Status: ${HTTP_CODE} (waiting for 200)"
            sleep 10
          done
          
          echo ""
          echo "‚ùå Timeout waiting for preview environment"
          echo "ready=false" >> $GITHUB_OUTPUT
          exit 1
      
      # --------------------------------------------------------
      # Run tests against the live preview environment
      # --------------------------------------------------------
      - name: üß™ Run E2E tests
        if: steps.wait.outputs.ready == 'true'
        run: |
          PREVIEW_URL="https://preview-pr-${{ needs.build.outputs.pr_number }}.${{ env.PREVIEW_DOMAIN }}"
          
          echo "üß™ Running tests against: ${PREVIEW_URL}"
          echo ""
          
          # Test 1: Health endpoint returns 200
          echo "Test 1: Health endpoint..."
          HEALTH_RESPONSE=$(curl -s "${PREVIEW_URL}/health")
          echo "Response: ${HEALTH_RESPONSE}"
          
          if echo "$HEALTH_RESPONSE" | grep -q '"status":"healthy"'; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ùå Health check failed"
            exit 1
          fi
          
          # Test 2: Main page loads
          echo ""
          echo "Test 2: Main page loads..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${PREVIEW_URL}/")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Main page loads (HTTP ${HTTP_CODE})"
          else
            echo "‚ùå Main page failed (HTTP ${HTTP_CODE})"
            exit 1
          fi
          
          # Test 3: Verify build info is correct
          echo ""
          echo "Test 3: Verify build metadata..."
          HEALTH_JSON=$(curl -s "${PREVIEW_URL}/health")
          
          EXPECTED_PR="${{ needs.build.outputs.pr_number }}"
          if echo "$HEALTH_JSON" | grep -q "\"pr_number\":\"${EXPECTED_PR}\""; then
            echo "‚úÖ PR number matches (#${EXPECTED_PR})"
          else
            echo "‚ö†Ô∏è PR number mismatch (expected #${EXPECTED_PR})"
            echo "Response: ${HEALTH_JSON}"
          fi
          
          echo ""
          echo "üéâ All tests passed!"
      
      # --------------------------------------------------------
      # Report test results back to PR
      # --------------------------------------------------------
      - name: üìä Report test results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.build.outputs.pr_number }};
            const previewUrl = `https://preview-pr-${prNumber}.${{ env.PREVIEW_DOMAIN }}`;
            const ready = '${{ steps.wait.outputs.ready }}' === 'true';
            const testsPassed = '${{ job.status }}' === 'success';
            
            let statusEmoji = testsPassed ? '‚úÖ' : '‚ùå';
            let statusText = testsPassed ? 'All tests passed!' : 'Tests failed';
            
            if (!ready) {
              statusEmoji = '‚è±Ô∏è';
              statusText = 'Environment failed to start within timeout';
            }
            
            const body = `## üß™ Test Results

            | Check | Status |
            |-------|--------|
            | Environment Ready | ${ready ? '‚úÖ Yes' : '‚ùå No'} |
            | Tests | ${statusEmoji} ${statusText} |

            ### üîó Preview URL
            ${ready ? `[Open Preview](${previewUrl})` : 'Environment not available'}
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  # ============================================================
  # JOB 4: Cleanup on PR Close (optional - ArgoCD handles this)
  # ============================================================
  # Note: This job is informational. ArgoCD automatically cleans up
  # when the PR closes because the ApplicationSet removes the
  # Application, and the finalizer deletes all K8s resources.
